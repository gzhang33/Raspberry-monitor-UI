<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClaw Monitor</title>
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #0f1419;
            --bg-tertiary: #151b23;
            --bg-hover: #1a222d;
            --border-color: #1e2632;
            --border-accent: #2d3a4a;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-yellow: #d29922;
            --accent-orange: #f78166;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
            --accent-cyan: #39c5cf;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            /* Spacing scale */
            --space-xs: 8px;
            --space-sm: 12px;
            --space-md: 20px;
            --space-lg: 28px;
            --space-xl: 40px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Full-width Layout */
        .app-layout {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header Bar */
        .header-bar {
            display: flex;
            padding: var(--space-md) var(--space-lg);
            gap: var(--space-md);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            align-items: center;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.875rem;
            color: var(--text-muted);
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            margin-left: auto;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.online {
            background: var(--accent-green);
        }

        .refresh-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            transition: all 0.15s ease;
            min-height: 48px;
            min-width: 48px;
        }

        .refresh-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-accent);
        }

        .refresh-btn:focus {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: var(--space-lg);
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
        }

        /* Stats Grid - Responsive */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        /* Stat Cards */
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--border-accent);
            background: var(--bg-tertiary);
        }

        .stat-card[data-has-trend] {
            cursor: pointer;
        }

        .stat-card:focus-within {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-color);
        }

        .stat-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .stat-icon {
            font-size: 1.5rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xs) 0;
            font-size: 1.0625rem;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .stat-highlight {
            color: var(--accent-blue);
            font-weight: 600;
            font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
            font-size: 1.125rem;
        }

        .progress-track {
            background: var(--bg-primary);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: var(--space-xs);
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .progress-fill.green { background: var(--accent-green); }
        .progress-fill.yellow { background: var(--accent-yellow); }
        .progress-fill.red { background: var(--accent-red); }

        /* Card Trend View */
        .card-metrics {}
        .card-trend {
            display: none;
        }

        .stat-card.show-trend .card-metrics {
            display: none;
        }

        .stat-card.show-trend .card-trend {
            display: block;
        }

        .card-trend-wrap {
            position: relative;
            width: 100%;
            height: 220px;
        }

        .card-trend canvas {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
        }

        /* Process Table */
        .process-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1rem;
            table-layout: fixed;
        }

        .process-table th {
            text-align: left;
            color: var(--text-secondary);
            padding: var(--space-sm) var(--space-xs);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            user-select: none;
            font-size: 1rem;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .process-table th:hover {
            color: var(--text-primary);
        }

        .process-table th.active-sort {
            color: var(--accent-blue);
        }

        .process-table td {
            padding: var(--space-sm) var(--space-xs);
            color: var(--text-primary);
            font-size: 1rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .process-table tr:hover td {
            background: var(--bg-hover);
        }

        .process-cmd {
            max-width: none;
        }

        .process-table thead th {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 2;
        }

        .process-table tbody tr {
            position: relative;
        }

        .process-table tbody tr::after {
            content: "PID " attr(data-pid);
            position: absolute;
            right: var(--space-sm);
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            opacity: 0;
            visibility: hidden;
            transition: opacity 150ms ease, visibility 150ms ease;
            pointer-events: none;
        }

        .process-table tbody tr:hover::after,
        .process-table tbody tr.show-pid::after {
            opacity: 1;
            visibility: visible;
        }

        .process-list-wrap {
            max-height: 280px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .process-table th:nth-child(1),
        .process-table td:nth-child(1) {
            width: 60%;
        }

        .process-table th:nth-child(2),
        .process-table td:nth-child(2) {
            width: 20%;
        }

        .process-table th:nth-child(3),
        .process-table td:nth-child(3) {
            width: 20%;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-accent);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.2s ease;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 768px) {
            html {
                font-size: 15px;
            }

            .header-bar {
                padding: var(--space-sm) var(--space-md);
            }

            .header-title {
                font-size: 1.25rem;
            }

            .content-area {
                padding: var(--space-md);
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: var(--space-md);
            }

            .stat-card {
                padding: var(--space-md);
            }

            .stat-title {
                font-size: 1.125rem;
            }

            .stat-row {
                font-size: 1rem;
            }

            .stat-highlight {
                font-size: 1rem;
            }

            .card-trend-wrap {
                height: 180px;
            }

            .process-cmd {
                max-width: 120px;
            }

            .header-status span:not(.status-dot) {
                display: none;
            }
        }

        @media (max-width: 480px) {
            html {
                font-size: 14px;
            }

            .header-bar {
                padding: var(--space-xs) var(--space-sm);
            }

            .header-title {
                font-size: 1.125rem;
            }

            .content-area {
                padding: var(--space-sm);
            }

            .stats-grid {
                gap: var(--space-sm);
            }

            .stat-card {
                padding: var(--space-sm);
            }

            .refresh-btn span:last-child {
                display: none;
            }

            .process-table th,
            .process-table td {
                padding: var(--space-xs);
                font-size: 0.9375rem;
            }

            .process-cmd {
                max-width: 90px;
            }
        }

        /* Accessibility: Focus visible for keyboard navigation */
        *:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        /* High contrast support */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #4a5568;
                --text-secondary: #a0aec0;
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Header Bar -->
        <header class="header-bar">
            <div class="header-logo">
                <span class="header-title">
                    <span>üìä</span>
                    System Monitor
                </span>
            </div>
            <div class="header-status">
                <span class="status-dot online"></span>
                <span id="update-time">Updated just now</span>
            </div>
            <button class="refresh-btn" onclick="manualRefresh()" aria-label="Refresh stats">
                <span id="refresh-icon">üîÑ</span>
                <span>Refresh</span>
            </button>
        </header>

        <!-- Content Area -->
        <main class="content-area" id="content-area">
            <div class="stats-grid">
                <!-- System Overview -->
                <section class="stat-card" aria-label="System Overview">
                    <div class="stat-header">
                        <span class="stat-title"><span class="stat-icon">üñ•Ô∏è</span> System Overview</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">OS</span>
                        <span class="stat-value" id="sys-os">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Uptime</span>
                        <span class="stat-value" id="sys-uptime">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Load Average</span>
                        <span class="stat-highlight" id="sys-load">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">IP Address</span>
                        <span class="stat-value" id="sys-ip">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Tailscale</span>
                        <span class="stat-highlight" id="sys-ts-ip">-</span>
                    </div>
                    <div class="stat-row" id="row-docker" style="display: none;">
                        <span class="stat-label">Docker</span>
                        <span class="stat-highlight" id="sys-docker">-</span>
                    </div>
                </section>

                <!-- CPU -->
                <section class="stat-card" data-has-trend="cpu" onclick="toggleCardTrend('cpu', event)" tabindex="0" onkeydown="handleCardKeydown('cpu', event)" aria-label="CPU Statistics - Click to toggle trend chart">
                    <div class="stat-header">
                        <span class="stat-title"><span class="stat-icon">‚öôÔ∏è</span> CPU</span>
                    </div>
                    <div class="card-metrics">
                        <div class="stat-row">
                            <span class="stat-label">Usage</span>
                            <span class="stat-value" id="cpu-val">0%</span>
                        </div>
                        <div class="progress-track">
                            <div id="cpu-bar" class="progress-fill green" style="width: 0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="stat-row" style="margin-top: 12px;">
                            <span class="stat-label">Frequency</span>
                            <span class="stat-highlight" id="cpu-freq">0 MHz</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Temperature</span>
                            <span class="stat-value" id="temp-val">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Throttle/Undervolt</span>
                            <span class="stat-value" id="cpu-throttled" title="">-</span>
                        </div>
                    </div>
                    <div class="card-trend">
                        <div class="card-trend-wrap">
                            <canvas id="trend-canvas-cpu" width="320" height="220"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Memory -->
                <section class="stat-card" data-has-trend="mem" onclick="toggleCardTrend('mem', event)" tabindex="0" onkeydown="handleCardKeydown('mem', event)" aria-label="Memory Statistics - Click to toggle trend chart">
                    <div class="stat-header">
                        <span class="stat-title"><span class="stat-icon">üß†</span> Memory</span>
                    </div>
                    <div class="card-metrics">
                        <div class="stat-row">
                            <span class="stat-label">RAM Usage</span>
                            <span class="stat-value" id="mem-val">0%</span>
                        </div>
                        <div class="progress-track">
                            <div id="mem-bar" class="progress-fill green" style="width: 0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="stat-row" style="margin-top: 6px;">
                            <span class="stat-label" id="mem-detail">0 / 0 GB</span>
                        </div>
                        <div class="stat-row" style="margin-top: 12px;">
                            <span class="stat-label">Swap</span>
                            <span class="stat-value" id="swap-val">0%</span>
                        </div>
                        <div class="progress-track">
                            <div id="swap-bar" class="progress-fill yellow" style="width: 0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="card-trend">
                        <div class="card-trend-wrap">
                            <canvas id="trend-canvas-mem" width="320" height="220"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Disk & Voltage -->
                <section class="stat-card" aria-label="Disk and Voltage Statistics">
                    <div class="stat-header">
                        <span class="stat-title"><span class="stat-icon">üíæ</span> Disk & Voltage</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Disk (Root)</span>
                        <span class="stat-value" id="disk-val">0%</span>
                    </div>
                    <div class="progress-track">
                        <div id="disk-bar" class="progress-fill green" style="width: 0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="stat-row" style="margin-top: 6px;">
                        <span class="stat-label" id="disk-detail">0 / 0 GB</span>
                    </div>
                    <div class="stat-row" style="margin-top: 10px;">
                        <span class="stat-label">Disk Read</span>
                        <span class="stat-highlight" id="disk-read-mb-s">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Disk Write</span>
                        <span class="stat-highlight" id="disk-write-mb-s">-</span>
                    </div>
                    <div class="stat-row" style="margin-top: 16px;">
                        <span class="stat-label">Core Voltage</span>
                        <span class="stat-highlight" id="volt-val">- V</span>
                    </div>
                </section>

                <!-- Network -->
                <section class="stat-card" data-has-trend="net" onclick="toggleCardTrend('net', event)" tabindex="0" onkeydown="handleCardKeydown('net', event)" aria-label="Network Statistics - Click to toggle trend chart">
                    <div class="stat-header">
                        <span class="stat-title"><span class="stat-icon">üåê</span> Network</span>
                    </div>
                    <div class="card-metrics">
                        <div class="stat-row">
                            <span class="stat-label">‚¨áÔ∏è Download</span>
                            <span class="stat-highlight" id="net-rx">0 MB/s</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">‚¨ÜÔ∏è Upload</span>
                            <span class="stat-highlight" id="net-tx">0 MB/s</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Ping</span>
                            <span class="stat-highlight" id="net-ping-ms">-</span>
                        </div>
                        <div class="stat-row" style="border-top: 1px solid var(--border-color); padding-top: 8px; margin-top: 12px;">
                            <span class="stat-label">Speedtest (DL/UL)</span>
                            <span class="stat-highlight" id="net-speedtest" title="Background speed test, refreshed periodically">-</span>
                        </div>
                        <div class="stat-row" style="margin-top: 12px; border-top: 1px solid var(--border-color); padding-top: 8px;">
                            <span class="stat-label">Total RX</span>
                            <span class="stat-value" id="net-total-rx">0 GB</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total TX</span>
                            <span class="stat-value" id="net-total-tx">0 GB</span>
                        </div>
                    </div>
                    <div class="card-trend">
                        <div class="card-trend-wrap">
                            <canvas id="trend-canvas-net" width="320" height="220"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Processes -->
                <section class="stat-card" aria-label="Top Processes">
                    <div class="stat-header">
                        <span class="stat-title"><span class="stat-icon">üìä</span> Top Processes</span>
                    </div>
                    <div class="process-list-wrap">
                        <table class="process-table" role="grid">
                            <thead>
                                <tr>
                                    <th scope="col">CMD</th>
                                    <th scope="col" onclick="handleProcessSort('cpu')" tabindex="0" onkeydown="handleSortKeydown('cpu', event)" id="sort-cpu">CPU ‚Üï</th>
                                    <th scope="col" onclick="handleProcessSort('mem')" tabindex="0" onkeydown="handleSortKeydown('mem', event)" id="sort-mem">MEM ‚Üï</th>
                                </tr>
                            </thead>
                            <tbody id="proc-list"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        window.OPENCLAW_MONITOR_BASE = (function(){ var p = window.location.pathname; if (p.startsWith('/monitor')) return '/monitor'; return ''; })();
        // Configuration
        const POLL_INTERVAL = 5000;

        // State
        let updateInProgress = false;
        let pollTimerId = null;
        let processSortField = 'cpu';
        let processSortAsc = false;
        let currentProcesses = [];
        
        // Trend history
        const historyLimit = 30;
        const statsHistory = {
            cpu: [],
            mem: [],
            net: []
        };

        // ============================================
        // System Stats
        // ============================================
        async function updateSystemStats() {
            if (updateInProgress) return;
            updateInProgress = true;
            try {
                const response = await fetch((window.OPENCLAW_MONITOR_BASE||'')+'/api/system-stats');
                const data = await response.json();
                if (!data || !data.overview) return;

                // 1. Overview
                document.getElementById('sys-os').textContent = data.overview.os || 'Linux';
                document.getElementById('sys-uptime').textContent = data.overview.uptime || '-';
                document.getElementById('sys-load').textContent = `${data.overview.load_1}  ${data.overview.load_5}  ${data.overview.load_15}`;
                document.getElementById('sys-ip').textContent = data.overview.ip || '-';
                
                const dockerRow = document.getElementById('row-docker');
                const dockerEl = document.getElementById('sys-docker');
                if (dockerRow && dockerEl) {
                    const d = data.overview.docker;
                    if (d != null) {
                        dockerRow.style.display = '';
                        dockerEl.textContent = d.running + ' running / ' + (d.stopped || 0) + ' stopped';
                    } else {
                        dockerRow.style.display = 'none';
                    }
                }

                // 2. CPU
                const cpuPct = data.cpu.percent;
                document.getElementById('cpu-val').textContent = cpuPct + '%';
                updateBar('cpu-bar', cpuPct);
                document.getElementById('cpu-freq').textContent = data.cpu.freq + ' MHz';
                
                statsHistory.cpu.push(cpuPct);
                if (statsHistory.cpu.length > historyLimit) statsHistory.cpu.shift();
                if (document.querySelector('.stat-card[data-has-trend="cpu"].show-trend')) drawTrendInCard('cpu');
                
                if (data.sensors.temp) {
                    document.getElementById('temp-val').textContent = data.sensors.temp + '¬∞C';
                }
                
                const throttledEl = document.getElementById('cpu-throttled');
                if (throttledEl) {
                    const t = data.sensors.throttled;
                    if (!t) {
                        throttledEl.textContent = '-';
                        throttledEl.title = '';
                    } else if (t.raw === 0) {
                        throttledEl.textContent = 'Normal';
                        throttledEl.title = 'No throttling/undervolt';
                    } else {
                        const parts = [];
                        if (t.current_undervolt || t.past_undervolt) parts.push('Undervolt');
                        if (t.current_throttled || t.past_throttled) parts.push('Throttled');
                        if (t.current_soft_temp || t.past_soft_temp) parts.push('Temp limit');
                        if (t.current_arm_freq_capped || t.past_arm_freq_capped) parts.push('Freq cap');
                        const warn = t.current_undervolt || t.current_throttled || t.current_soft_temp || t.current_arm_freq_capped;
                        throttledEl.textContent = (warn ? '‚ö†Ô∏è ' : '') + (parts.length ? parts.join(' ') : '0x' + t.raw.toString(16));
                    }
                }

                // 3. Memory
                const mem = data.memory;
                document.getElementById('mem-val').textContent = mem.percent + '%';
                updateBar('mem-bar', mem.percent);
                document.getElementById('mem-detail').textContent = `${mem.used_gb} / ${mem.total_gb} GB`;
                
                statsHistory.mem.push(mem.percent);
                if (statsHistory.mem.length > historyLimit) statsHistory.mem.shift();
                if (document.querySelector('.stat-card[data-has-trend="mem"].show-trend')) drawTrendInCard('mem');
                
                document.getElementById('swap-val').textContent = mem.swap_percent + '%';
                updateBar('swap-bar', mem.swap_percent);

                // 4. Disk & Voltage
                const disk = data.disk;
                document.getElementById('disk-val').textContent = disk.percent + '%';
                updateBar('disk-bar', disk.percent);
                document.getElementById('disk-detail').textContent = `${disk.used_gb} / ${disk.total_gb} GB`;
                
                const diskReadEl = document.getElementById('disk-read-mb-s');
                const diskWriteEl = document.getElementById('disk-write-mb-s');
                if (diskReadEl) diskReadEl.textContent = disk.read_mb_s != null ? disk.read_mb_s.toFixed(2) + ' MB/s' : '-';
                if (diskWriteEl) diskWriteEl.textContent = disk.write_mb_s != null ? disk.write_mb_s.toFixed(2) + ' MB/s' : '-';

                document.getElementById('volt-val').textContent = data.sensors.voltage ? data.sensors.voltage + ' V' : 'N/A';

                // 5. Network
                const net = data.network;
                document.getElementById('net-rx').textContent = formatSpeed(net.rx_mb_s);
                document.getElementById('net-tx').textContent = formatSpeed(net.tx_mb_s);
                document.getElementById('net-total-rx').textContent = net.rx_total_gb + ' GB';
                document.getElementById('net-total-tx').textContent = net.tx_total_gb + ' GB';
                
                const pingEl = document.getElementById('net-ping-ms');
                if (pingEl) pingEl.textContent = net.ping_ms != null ? net.ping_ms + ' ms' : '-';
                
                // 5.1 Speedtest
                const stEl = document.getElementById('net-speedtest');
                if (stEl && net.speedtest) {
                    const st = net.speedtest;
                    const hasData = st.ping_ms !== null && st.download_mbps !== null && st.upload_mbps !== null;
                    const inProgress = Boolean(st.in_progress);
                    if (hasData) {
                        stEl.textContent = `${st.download_mbps.toFixed(1)} / ${st.upload_mbps.toFixed(1)} Mbps`;
                        stEl.title = `Ping: ${st.ping_ms} ms`;
                    } else if (inProgress) {
                        stEl.textContent = 'Testing...';
                        stEl.title = 'Speed test is running in background';
                    } else {
                        stEl.textContent = '-';
                        stEl.title = st.last_error ? `Last test failed: ${st.last_error}` : 'No speed test data yet';
                    }
                } else if (stEl) {
                    stEl.textContent = '-';
                    stEl.title = '';
                }
                
                statsHistory.net.push(net.rx_mb_s + net.tx_mb_s);
                if (statsHistory.net.length > historyLimit) statsHistory.net.shift();
                if (document.querySelector('.stat-card[data-has-trend="net"].show-trend')) drawTrendInCard('net');

                // 6. Processes
                currentProcesses = data.processes;
                renderProcesses(currentProcesses);

                // Tailscale IP
                const ts = data.tailscale;
                const tsEl = document.getElementById('sys-ts-ip');
                if (ts.tailscale_connected) {
                    tsEl.textContent = ts.tailscale_ip;
                    tsEl.style.color = 'var(--accent-green)';
                } else {
                    tsEl.textContent = 'Not connected';
                    tsEl.style.color = 'var(--accent-red)';
                }
                
                document.getElementById('update-time').textContent = 'Updated ' + new Date().toLocaleTimeString();

            } catch (error) {
                console.error('Stats update failed:', error);
            } finally {
                updateInProgress = false;
            }
        }

        function formatSpeed(mbps) {
            if (mbps >= 1) return mbps.toFixed(2) + ' MB/s';
            if (mbps > 0.001) return (mbps * 1024).toFixed(1) + ' KB/s';
            if (mbps > 0) return (mbps * 1024 * 1024).toFixed(0) + ' B/s';
            return '0 MB/s';
        }

        function updateBar(id, percent) {
            const bar = document.getElementById(id);
            bar.style.width = percent + '%';
            bar.setAttribute('aria-valuenow', percent);
            bar.className = 'progress-fill ' + (
                percent > 90 ? 'red' : 
                percent > 70 ? 'yellow' : 'green'
            );
        }

        function handleProcessSort(field) {
            if (processSortField === field) {
                processSortAsc = !processSortAsc;
            } else {
                processSortField = field;
                processSortAsc = false;
            }
            renderProcesses(currentProcesses);
        }

        function handleSortKeydown(field, event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                handleProcessSort(field);
            }
        }

        function renderProcesses(processes) {
            const procList = document.getElementById('proc-list');
            if (!procList) return;
            
            const sorted = [...processes].sort((a, b) => {
                const valA = a[processSortField];
                const valB = b[processSortField];
                return processSortAsc ? valA - valB : valB - valA;
            });

            ['cpu', 'mem'].forEach(f => {
                const el = document.getElementById(`sort-${f}`);
                if (el) {
                    el.className = processSortField === f ? 'active-sort' : '';
                    el.textContent = f.toUpperCase() + (processSortField === f ? (processSortAsc ? ' ‚Üë' : ' ‚Üì') : ' ‚Üï');
                }
            });

            procList.innerHTML = sorted.map(p => `
                <tr class="process-row" data-pid="${p.pid}" tabindex="0">
                    <td class="process-cmd" title="${p.name}">${p.name}</td>
                    <td>${p.cpu}%</td>
                    <td>${p.mem}%</td>
                </tr>
            `).join('');

            procList.querySelectorAll('.process-row').forEach(row => {
                row.addEventListener('click', () => {
                    row.classList.toggle('show-pid');
                });
                row.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        row.classList.toggle('show-pid');
                    }
                });
            });
        }

        // ============================================
        // Trend Charts
        // ============================================
        function handleCardKeydown(type, event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                toggleCardTrend(type, event);
            }
        }

        function toggleCardTrend(type, e) {
            if (e) e.stopPropagation();
            const card = document.querySelector(`.stat-card[data-has-trend="${type}"]`);
            if (!card) return;
            const isShow = card.classList.toggle('show-trend');
            if (isShow) drawTrendInCard(type);
        }

        function drawTrendInCard(type) {
            const canvas = document.getElementById('trend-canvas-' + type);
            if (!canvas) return;
            const data = statsHistory[type];
            const colors = { cpu: '#3fb950', mem: '#58a6ff', net: '#d29922' };
            const yUnit = { cpu: '%', mem: '%', net: 'MB/s' }[type];
            if (!data || data.length < 2) {
                const { lw, lh } = setupCanvasDPR(canvas);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, lw, lh);
                ctx.fillStyle = '#6e7681';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Collecting data...', lw / 2, lh / 2);
                return;
            }
            drawTrendWithAxes(canvas, data, colors[type] || '#58a6ff', yUnit, type === 'net');
        }

        function setupCanvasDPR(canvas) {
            const dpr = Math.min(window.devicePixelRatio || 1, 2);
            const wrap = canvas.parentElement;
            const rect = wrap ? wrap.getBoundingClientRect() : { width: 320, height: 220 };
            const lw = Math.floor(rect.width);
            const lh = Math.floor(rect.height);
            if (canvas.width !== lw * dpr || canvas.height !== lh * dpr) {
                canvas.width = lw * dpr;
                canvas.height = lh * dpr;
                canvas.style.width = lw + 'px';
                canvas.style.height = lh + 'px';
            }
            const ctx = canvas.getContext('2d');
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(dpr, dpr);
            return { lw, lh, dpr };
        }

        function drawTrendWithAxes(canvas, data, color, yUnit, isNetwork) {
            const { lw: w, lh: h } = setupCanvasDPR(canvas);
            const ctx = canvas.getContext('2d');
            const padding = { top: 24, right: 12, bottom: 30, left: 50 };
            const plotW = w - padding.left - padding.right;
            const plotH = h - padding.top - padding.bottom;

            ctx.clearRect(0, 0, w, h);
            ctx.fillStyle = '#0a0e14';
            ctx.fillRect(0, 0, w, h);

            const maxVal = isNetwork ? Math.max(...data, 0.1) : Math.max(...data, 10);
            const minVal = 0;
            const range = maxVal - minVal || 1;

            function formatY(v) {
                if (isNetwork) return v >= 1 ? v.toFixed(1) : v.toFixed(2);
                if (v >= 100) return Math.round(v);
                if (v >= 10) return v.toFixed(0);
                return v % 1 === 0 ? v.toFixed(0) : v.toFixed(1);
            }

            // Y-Axis
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.font = '13px -apple-system, BlinkMacSystemFont, sans-serif';
            
            const yTicks = 4;
            for (let i = 0; i <= yTicks; i++) {
                const ratio = i / yTicks;
                const y = padding.top + plotH * ratio;
                const v = maxVal - range * ratio;

                ctx.beginPath();
                ctx.strokeStyle = '#1e2632';
                ctx.lineWidth = 1;
                ctx.setLineDash([4, 4]);
                ctx.moveTo(padding.left, y);
                ctx.lineTo(w - padding.right, y);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.fillStyle = '#8b949e';
                ctx.fillText(formatY(v), padding.left - 10, y);
            }

            if (yUnit) {
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(yUnit, 6, 14);
            }

            // Trend Line
            if (data.length > 1) {
                const stepX = plotW / (data.length - 1);
                
                const grad = ctx.createLinearGradient(0, padding.top, 0, h - padding.bottom);
                grad.addColorStop(0, hexToRgba(color, 0.3));
                grad.addColorStop(1, hexToRgba(color, 0.0));

                ctx.beginPath();
                data.forEach((val, i) => {
                    const x = padding.left + i * stepX;
                    const normalized = (val - minVal) / range;
                    const y = padding.top + plotH * (1 - normalized);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                
                ctx.lineTo(padding.left + (data.length - 1) * stepX, h - padding.bottom);
                ctx.lineTo(padding.left, h - padding.bottom);
                ctx.closePath();
                ctx.fillStyle = grad;
                ctx.fill();

                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = 2.5;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                data.forEach((val, i) => {
                    const x = padding.left + i * stepX;
                    const normalized = (val - minVal) / range;
                    const y = padding.top + plotH * (1 - normalized);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }

            // X-Axis
            ctx.beginPath();
            ctx.strokeStyle = '#2d3a4a';
            ctx.lineWidth = 1;
            ctx.moveTo(padding.left, h - padding.bottom);
            ctx.lineTo(w - padding.right, h - padding.bottom);
            ctx.stroke();

            ctx.fillStyle = '#6e7681';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';

            const xTickCount = Math.min(data.length - 1, 5);
            const drawnSecs = new Set();
            
            for (let i = 0; i <= xTickCount; i++) {
                const idx = Math.round((i / xTickCount) * (data.length - 1));
                const x = padding.left + (idx / (data.length - 1)) * plotW;
                const sec = (data.length - 1 - idx) * 5;

                if (!drawnSecs.has(sec)) {
                    drawnSecs.add(sec);
                    ctx.fillText(sec + 's', x, h - padding.bottom + 8);
                }
            }
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // ============================================
        // Utility Functions
        // ============================================
        async function manualRefresh() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('spinning');
            
            await updateSystemStats();
            
            setTimeout(() => {
                icon.classList.remove('spinning');
            }, 500);
        }

        // ============================================
        // Initialize
        // ============================================
        function startPolling() {
            if (pollTimerId != null) return;
            pollTimerId = setInterval(() => {
                if (document.hidden) return;
                updateSystemStats();
            }, POLL_INTERVAL);
        }

        function stopPolling() {
            if (pollTimerId != null) {
                clearInterval(pollTimerId);
                pollTimerId = null;
            }
        }

        function onVisibilityChange() {
            if (document.hidden) {
                stopPolling();
            } else {
                updateSystemStats();
                startPolling();
            }
        }

        async function init() {
            await updateSystemStats();
            document.addEventListener('visibilitychange', onVisibilityChange);
            if (!document.hidden) startPolling();
        }

        init();
    </script>
</body>
</html>
